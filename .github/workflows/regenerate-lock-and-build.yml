name: Regenerate lock, build and commit

on:
  workflow_dispatch:
  push:
    branches:
      - copilot/fix-node-domexception-issue

jobs:
  regen-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps (regenerate lock)
        run: |
          npm ci || npm install
      - name: Log Next version
        run: |
          node -e "console.log('next version:', require('./node_modules/next/package.json').version)"
      - name: Check node-domexception in tree
        run: |
          echo "=== npm why node-domexception ==="
          npm why node-domexception || true
      - name: Build
        env:
          NEXT_TELEMETRY_DISABLED: 1
        run: |
          npm run build

      - name: npm audit (report)
        run: |
          npm audit --audit-level=moderate || true

      - name: Commit lockfile if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain package-lock.json)" ]; then
            git add package-lock.json
            git commit -m "chore: regenerate package-lock.json via workflow"
            git push
          else
            echo "No lockfile changes"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
